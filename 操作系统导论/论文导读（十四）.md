# Towards A More Practical Model for Mixed Criticality Systems

## 一、前提内容

### 1.1 标准模型

混合关键度系统执行在两种模式下：HI - crit模式和LO - crit模式。每个任务由其作业的最小到达时间间隔（周期用T表示）、截止期限（相对于每个作业的释放，表示为D）和最坏执行时间（每个关键级别一个，分别表示为C(HI)和C(LO)）来表示，且C(HI) ≥ C(LO)。系统初始处于LO - crit模式，只要所有作业在其低关键度计算时间C(LO)内执行，就保持该模式。如果任何作业执行达到C(LO)时间而未完成，则系统立即切换到HI - crit模式，此时所有LO - crit任务被放弃，不再执行新的LO - crit作业，系统保持在HI - crit模式，且任务之间相互独立（除处理器外不共享任何资源）。

### 1.2 引起的问题

1. 在高关键度模式下，低关键度任务被完全放弃，系统工程师认为低关键度任务应能取得一些进展，只要它们不干扰高关键度任务。
2. 对于长时间运行的系统，应能在条件合适时返回低关键度模式，但标准模型中初始关键度级别一旦改变就不再返回。
3. 高关键度任务执行超过其低关键度计算时间C(LO)必须引发模式改变，而低关键度任务不应执行超过C(LO)导致模式改变，但标准模型中未作此区分。

## 二、引入替代模型

### 2.1 降低低关键性任务的优先级

* 低关键性任务有两个优先级Pi(LO)和Pi(HI)，且Pi(HI) ≤ Pi(LO)，Pi(HI) < minj∈HI (Pj)（HI为所有高关键度任务的集合）。在任务暂停时修改其优先级，以降低运行时开销。
* 从高关键度模式返回低关键度模式时，可等待系统空闲时进行模式改变，以避免对新的低关键度模式产生行为影响。
* 高关键度任务的执行时间没有限制，若系统在高关键度模式下出现空闲节拍，则可返回低关键度模式，低关键度任务的执行时间预算可恢复到原始值C(LO)。但需注意，若在低关键度模式下任务执行过程中发生模式改变且预算降低，低关键度任务不保证能在截止期限前获得C(LO)的处理时间，但能保证获得C(HI)的处理时间。

### 2.2 降低低关键性任务的执行时间预算

* 该方案在保证高关键性模式下为一些低关键度任务提供至少一定程度的服务。引入了任务参数（如Ti、Di、Li、Ci(LO)和Ci(HI)等）和系统行为的定义。```对于高关键度任务，Ci(HI) ≥ Ci(LO)；对于低关键度任务，Ci(LO) ≥ Ci(HI)，且对于某些低关键度任务，Ci(HI)可能为零，表示系统进入高关键度模式后此类任务的作业不开始执行。```
* 任务的优先级从不修改，低关键度任务的作业在低关键度模式下执行不能超过其Ck(LO)参数，在高关键度模式下不能超过其Ck(HI)参数，否则任务将被暂停至下一次释放。
* 给出了计算高关键度任务和低关键度任务响应时间的公式，并可通过敏感性分析探索设计空间，例如考虑多少低关键度任务能拥有全部容量（即C(HI) = C(LO)），其他任务的C(HI) = 0；为使系统可调度，所有低关键度任务的C(LO)应减少多少（即C(HI) = α · C(LO)，α < 1）；

### 2.3 增加低关键度任务的周期

应用弹性调度模型的思想，允许低关键度任务在模式改变后有两个周期值：Ti(LO)和Ti(HI)，且Ti(LO) ≤ Ti(HI)。模式改变后，任务可再次释放，但周期延长（可能预算也减少）。

## 三、提高有效性的策略

为了提高上面三个方案，特别是第二个方案的有效性，这篇文章提出了一些辅助策略：

1. 使用方案一：结合使用不同方案
   * 该策略是将降低LO - crit任务优先级的方案与其他保证一定服务水平的方案结合使用。
   * 具体来说，一旦低关键度（LO - crit）作业使用完其C(HI)预算，其优先级就会降低到背景级别（Pi(HI)），此时它可以继续执行。
   * 这样做的目的是在保证LO - crit任务能够在一定程度上继续运行的同时，避免其对HI - crit任务产生干扰。通过这种方式，可以更好地利用系统资源，提高系统的整体性能。
2. 使用方案二：直接分配备用容量
   * 该策略是将HI - crit作业的备用容量直接分配给LO - crit作业。
   * 为了实现这一策略，可以利用先前为组合硬实时和软实时固定优先级任务集开发的技术，如Extended Priority Exchange（扩展优先级交换）、Capacity Sharing（容量共享）和History Rewriting（历史重写）。
   * 在混合关键度系统的背景下，这些技术的工作方式如下：
     * 所有HI - crit任务都有一个等于其最大保证执行时间C(HI)的预算。
     * 在运行时，监测每个HI - crit作业的实际执行时间。
     * 当一个作业在释放时间s和绝对截止时间d（d = s + D）内完成时，记录其实际执行时间（e）并计算其增益时间（g），g = C(HI) - e，且g被假设为非负。
     * 增益时间可用于分配给较低优先级的作业，且必须在截止时间d之前使用。
       

对于Extended Priority Exchange：

* 增益时间被分配给下一个准备执行的最高优先级任务的预算。（注意，如果没有准备好的任务，则增益时间丢失。）

对于Capacity Sharing：

* 执行作业首先使用其自己的C(HI)预算。
* 当该预算耗尽时，它从任何可用的更高优先级增益时间中“下拉”额外容量。
* LO - crit作业被称为插入到主机HI - crit作业的预算中。
* 当截止时间到达、容量耗尽或作业完成时，插头断开。
* 如果有多个更高优先级的增益时间可用，则可以选择任何一个，甚至可以同时使用多个。有用的启发式方法是：首先使用最大的g，或首先使用最早的d。

对于History Rewriting：

* 在作业的截止时间（d），记录增益时间（g）。
* 选择一个在d之前已执行时间为e的较低优先级任务，并将其预算增加max(g, e - g)，同时g减少此金额。
* 任何剩余的增益时间进一步分配给更低优先级的任务。


